<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Reports - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/reportstyle.css">
    <style>
        /* --- UPDATED LAYOUT FOR PERFECT CENTERING --- */
        .nav-controls {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* 3 Columns: Left, Center (Auto), Right */
            align-items: center;
            margin-bottom: 15px;
        }

        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .nav-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Force buttons to stick to the edges */
        #prev-btn { justify-self: start; }
        #next-btn { justify-self: end; }
        
        /* Headline Style */
        .counter { 
            color: #ccc; 
            font-size: 1.1em; 
            font-weight: 600;
            text-align: center;
            white-space: nowrap; /* Prevent text from stacking */
        }
        
        /* FIX: Ensure delete button container spans full width for centering */
        .delete-container {
            display: flex;
            justify-content: center; /* Center horizontally */
            margin-bottom: 25px;      /* Space between button and form */
            width: 100%; /* Ensure it spans the full width of its parent */
        }

        .delete-btn {
            background: #ef4444; /* Red */
            color: white;
            border: none;
            padding: 10px 40px; /* Wider button */
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .delete-btn:hover {
            background: #cc0000;
        }
        .delete-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* NEW STYLE: Make the Reporter Name span two columns (full width) */
        .full-width {
            grid-column: 1 / -1; 
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="logo"> 
            <span>TUPark</span>
            <img src="/image/TUPARK.png" alt="Logo" class="logo-img">
            <img src="/tup-logo.png" alt="TUP Logo" class="tup-logo">
        </div> 
        <nav>
            <ul>
                <li><a href="/admin">Home</a></li>
            </ul>
        </nav>
    </header>

    <main class="report-container">
        <div class="problem-report">
            
            <div class="nav-controls">
                <button id="prev-btn" class="nav-btn" onclick="changeReport(-1)">&#8592; Previous</button>
                <span class="counter">Report <span id="current-index">0</span> of <span id="total-count">0</span></span>
                <button id="next-btn" class="nav-btn" onclick="changeReport(1)">Next &#8594;</button>
            </div>

            <div class="delete-container">
                <button id="delete-btn" class="delete-btn" onclick="deleteCurrentReport()">Delete Report</button>
            </div>

            <div class="header-section">
                <label style="color:white; margin-bottom:5px; display:block;">Description:</label>
                <div class="large-display-area" id="desc-box">
                    Loading reports...
                </div>
            </div>

            <div class="input-grid">
                
                <div class="report-group">
                    <label>Category of Problem:</label>
                    <div class="display-box" id="cat-box">-</div>
                </div>
                
                <div class="report-group">
                    <label>Date and Time:</label>
                    <div class="display-box" id="date-box">-</div>
                </div>

                <div class="report-group">
                    <label>Vehicle Plate Number:</label>
                    <div class="display-box" id="plate-box">-</div>
                </div>
                
                <div class="report-group">
                    <label>Reported Slot ID:</label>
                    <div class="display-box" id="slot-box">-</div> 
                </div>

                <div class="report-group full-width">
                    <label>Reporter Name:</label>
                    <div class="display-box" id="name-box">-</div>
                </div>

            </div>
            
        </div>
    </main>
    
    <script>
        let reports = [];
        let currentIndex = 0;

        // 1. Fetch Reports
        function fetchReports() {
            fetch('/api/admin/reports')
                .then(res => res.json())
                .then(data => {
                    reports = data;
                    
                    if (reports.length > 0) {
                        if (currentIndex >= reports.length) {
                            currentIndex = reports.length - 1;
                        }
                        renderReport(currentIndex);
                    } else {
                        showEmptyState();
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('desc-box').innerText = "Error loading reports.";
                });
        }

        // 2. Render Report
        function renderReport(index) {
            const report = reports[index];
            
            document.getElementById('desc-box').innerText = report.description;
            document.getElementById('cat-box').innerText = report.category;
            document.getElementById('name-box').innerText = report.reporter_name;
            document.getElementById('plate-box').innerText = report.plate_number;
            // Render the slot ID
            document.getElementById('slot-box').innerText = report.slot_number || 'N/A'; // Use slot_number assuming API provides it

            const dateObj = new Date(report.report_date);
            document.getElementById('date-box').innerText = dateObj.toLocaleString();

            document.getElementById('current-index').innerText = index + 1;
            document.getElementById('total-count').innerText = reports.length;

            updateButtons();
        }

        // 3. Empty State
        function showEmptyState() {
            document.getElementById('desc-box').innerText = "No reports found.";
            document.getElementById('cat-box').innerText = "-";
            document.getElementById('date-box').innerText = "-";
            document.getElementById('name-box').innerText = "-";
            document.getElementById('plate-box').innerText = "-";
            document.getElementById('slot-box').innerText = "-"; // Reset slot box
            
            document.getElementById('current-index').innerText = "0";
            document.getElementById('total-count').innerText = "0";
            
            document.getElementById('prev-btn').disabled = true;
            document.getElementById('next-btn').disabled = true;
            document.getElementById('delete-btn').disabled = true;
        }

        // 4. Navigation
        function changeReport(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < reports.length) {
                currentIndex = newIndex;
                renderReport(currentIndex);
            }
        }

        function updateButtons() {
            document.getElementById('prev-btn').disabled = (currentIndex === 0);
            document.getElementById('next-btn').disabled = (currentIndex === reports.length - 1);
            document.getElementById('delete-btn').disabled = false;
        }

        // 5. Delete Function
        async function deleteCurrentReport() {
            const report = reports[currentIndex];
            if (!report) return;

            if (confirm("Delete this report permanently?")) {
                try {
                    const response = await fetch(`/api/admin/reports/${report.id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert("Report deleted.");
                        fetchReports(); // Refresh
                    } else {
                        alert("Error: " + result.message);
                    }
                } catch (err) {
                    console.error(err);
                    alert("System Error.");
                }
            }
        }
        
        // Make functions globally accessible (for inline onclick)
        window.changeReport = changeReport;
        window.deleteCurrentReport = deleteCurrentReport;

        // Initialize
        fetchReports();
    </script>
</body>
</html>