<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Parking Availability</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<link rel="stylesheet" href="adminstyle.css" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
</head>
<body>
 
  <header class="navbar">
    <div class="logo"> 
      <span>TUPark</span>
      <img src="/TUPARK.png" alt="Logo" class="logo-img">
    </div> 
    <nav>
      <ul>
        <li><a href="/admin">Home</a></li>
        <li><a href="/admin/reports">User Reports</a></li>
        <li><a href="#" onclick="openLogsModal()">Admin Logs</a></li>
        <li><a href="#" onclick="openChartsModal()">Statistics</a></li> 
        <li><a href="/logout" style="color: #ff4444;">Logout</a></li>
      </ul>
    </nav>
  </header>

  <div class="hero-bg"></div>
  <div class="hero-overlay"></div>

  <div class="main-content">
    <div class="container">
      <div class="filter-box">
        <div class="filter-header">
          <h2>Filter</h2>
          <button id="reset-filter" class="reset-btn">Reset</button>
        </div>

        <div class="form-group">
          <label for="park-location">Park Location</label>
          <select id="park-location">
            <option value="none">Select a location</option>
            <option value="building1">COS & CLA</option>
            <option value="building2">Library</option>
            <option value="building3">Court</option>
            <option value="building4">CIT</option>
            <option value="building5">Maintainance</option>
            <option value="building6">IRTC</option>
            <option value="building7">Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label for="vehicle-type">Type of Vehicle</label>
          <select id="vehicle-type">
            <option value="all">All</option> <option value="Car">Car</option>
            <option value="Motorcycle">Motorcycle</option>
            <option value="Van">Van</option>
            <option value="Others">Others</option>
          </select>
        </div>

        <div class="section-divider">
          <h3>Show Only</h3>
          <div class="checkbox-group">
            <input type="checkbox" id="available-spot" />
            <label for="available-spot">Available Spot</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="unavailable-spot" />
            <label for="unavailable-spot">Unavailable Spot</label>
          </div>
        </div>

        <div class="section-divider">
          <h3>Current Status</h3>
          <div class="status">
            <div class="status-item">
              <span>COS & CLA:</span>
              <span id="count-building1" class="value-green">0/27</span>
            </div>
            <div class="status-item">
              <span>Library</span>
              <span id="count-building2" class="value-green">0/8</span>
            </div>
            <div class="status-item">
              <span>Court</span>
              <span id="count-building3" class="value-green">0/13</span>
            </div>
            <div class="status-item">
              <span>CIT</span>
              <span id="count-building4" class="value-green">0/16</span>
            </div>
            <div class="status-item">
              <span>Maintainance</span>
              <span id="count-building5" class="value-green">0/10</span>
            </div>
            <div class="status-item">
              <span>IRTC:</span>
              <span id="count-building6" class="value-green">0/5</span>
            </div>
            <div class="status-item">
              <span>Admin</span>
              <span id="count-building7" class="value-green">0/6</span>
            </div>
          </div>
        </div>
      </div>

      <div class="map-wrapper">
      <div class="map-area">
        <div class="map-container">
          <img id="map-image" class="map-image" src="2.png" alt="Parking map" />
          <div id="spots-container"></div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <div id="spot-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">Spot Status</h3>
        <div id="modal-body">
            </div>
    </div>
  </div>

  <div id="logs-modal" class="modal">
  <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>System Activity Logs</h3>
        <span class="close-button" onclick="closeLogsModal()">&times;</span>
      </div>
      <div id="logs-list" style="flex: 1; overflow-y: auto; border-top: 1px solid #555; padding-top: 10px;">
          <p>Loading...</p>
      </div>
  </div>
</div>

  <div id="charts-modal" class="modal">
    <div class="modal-content charts-modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Occupancy Trends</h3>
            <span class="close-button" onclick="closeChartsModal()">&times;</span>
        </div>
        <div class="chart-grid">
            <div class="chart-card">
                <h3>Daily Occupancy</h3>
                <canvas id="dailyOccupancyChart"></canvas>
                <p class="chart-footer">Shows hourly occupancy count for the last 24 hours.</p>
            </div>
            <div class="chart-card">
                <h3>Weekly Occupancy</h3>
                <canvas id="weeklyOccupancyChart"></canvas>
                <p class="chart-footer">Shows total unique occupancy events per day over the last 7 days.</p>
            </div>
            <div class="chart-card">
                <h3>Monthly Occupancy</h3>
                <canvas id="monthlyOccupancyChart"></canvas>
                <p class="chart-footer">Shows average unique occupied slots per month (last 12 months).</p>
            </div>
        </div>
    </div>
  </div>
  <script>
// ==========================================
// 1. CONFIGURATION
// ==========================================
// ... (Lines 1-213 remain the same) ...
const locationSelect = document.getElementById('park-location');
const mapImage = document.getElementById('map-image');
const resetButton = document.getElementById('reset-filter');
const spotsContainer = document.getElementById('spots-container');
const availableCheckbox = document.getElementById('available-spot');
const unavailableCheckbox = document.getElementById('unavailable-spot');
const vehicleTypeSelect = document.getElementById('vehicle-type'); 
const modal = document.getElementById('spot-modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');

const mapImages = {
  none: '2.png',
  building1: 'COS & CLA.png',
  building2: 'LIBRARY.png',
  building3: 'COURT.png',
  building4: 'CIT.png',
  building5: 'MAINTAINANCE.png',
  building6: 'IRTC.png',
  building7: 'ADMIN.png'
};

const buildingSpotSizes = {
  building1: { width: 15, height: 35 },
  building2: { width: 30, height: 60 },
  building3: { width: 35, height: 75 },
  building4: { width: 29, height: 56 },
  building5: { width: 44, height: 87 },
  building6: { width: 44, height: 89 },
  building7: { width: 42, height: 83 }
};

// ==========================================
// 2. COORDINATES (Paste your full list!)
// ==========================================
const parkingSpots = {
  none: [],
  building1: [
    { spot_id: 'CLA1', top: '50%', left: '59px' },
    { spot_id: 'CLA2', top: '50%', left: '79px' },
    { spot_id: 'CLA3', top: '50%', left: '98px' },
    { spot_id: 'CLA4', top: '50%', left: '117px' },
    { spot_id: 'CLA5', top: '50%', left: '137px' },
    { spot_id: 'CLA6', top: '50%', left: '156px' },
    { spot_id: 'CLA7', top: '50%', left: '175px' },
    { spot_id: 'CLA8', top: '50%', left: '195px' },
    { spot_id: 'CLA9', top: '50%', left: '214px' },
    { spot_id: 'CLA10', top: '50%', left: '234px' },
    { spot_id: 'CLA11', top: '50%', left: '252px' },
    { spot_id: 'CLA12', top: '50%', left: '272px' },
    { spot_id: 'CLA13', top: '50%', left: '292px' },
    { spot_id: 'CLA14', top: '50%', left: '311px' },
    { spot_id: 'CLA15', top: '50%', left: '330px' },
    { spot_id: 'CLA16', top: '50%', left: '349px' },
    { spot_id: 'CLA17', top: '50%', left: '369px' },
    { spot_id: 'CLA18', top: '50%', left: '388px' },
    { spot_id: 'CLA19', top: '50%', left: '407px' },
    { spot_id: 'CLA20', top: '50%', left: '427px' },
    { spot_id: 'CLA21', top: '50%', left: '447px' },
    { spot_id: 'COS1', top: '50%', left: '549px' },
    { spot_id: 'COS2', top: '50%', left: '568px' },
    { spot_id: 'COS3', top: '50%', left: '588px' },
    { spot_id: 'COS4', top: '50%', left: '609px' },
    { spot_id: 'COS5', top: '50%', left: '628px' },
    { spot_id: 'COS6', top: '50%', left: '649px' },
  ],
  building2: [
    { spot_id: 'LIB1', top: '50%', left: '183px' },
    { spot_id: 'LIB2', top: '50%', left: '220px' },
    { spot_id: 'LIB3', top: '50%', left: '257px' },
    { spot_id: 'LIB4', top: '50%', left: '294px' },
    { spot_id: 'LIB5', top: '50%', left: '330px' },
    { spot_id: 'LIB6', top: '50%', left: '367px' },
    { spot_id: 'LIB7', top: '50%', left: '487px' },
    { spot_id: 'LIB8', top: '50%', left: '524px' }
  ],
  building3: [
    { spot_id: 'CRT1', top: '49%', left: '46px' },
    { spot_id: 'CRT2', top: '49%', left: '91px' },
    { spot_id: 'CRT3', top: '49%', left: '137px' },
    { spot_id: 'CRT4', top: '49%', left: '183px' },
    { spot_id: 'CRT5', top: '49%', left: '228px' },
    { spot_id: 'CRT6', top: '49%', left: '276px' },
    { spot_id: 'CRT7', top: '49%', left: '322px' },
    { spot_id: 'CRT8', top: '49%', left: '440px' },
    { spot_id: 'CRT9', top: '49%', left: '485px' },
    { spot_id: 'CRT10', top: '49%', left: '531px' },
    { spot_id: 'CRT11', top: '49%', left: '576px' },
    { spot_id: 'CRT12', top: '49%', left: '621px' },
    { spot_id: 'CRT13', top: '49%', left: '667px' }
  ],
  building4: [
    { spot_id: 'CIT1', top: '50%', left: '44px' },
    { spot_id: 'CIT2', top: '50%', left: '78px' },
    { spot_id: 'CIT3', top: '50%', left: '112px' },
    { spot_id: 'CIT4', top: '50%', left: '147px' },
    { spot_id: 'CIT5', top: '50%', left: '181px' },
    { spot_id: 'CIT6', top: '50%', left: '217px' },
    { spot_id: 'CIT7', top: '50%', left: '353px' },
    { spot_id: 'CIT8', top: '50%', left: '387px' },
    { spot_id: 'CIT9', top: '50%', left: '421px' },
    { spot_id: 'CIT0', top: '50%', left: '455px' },
    { spot_id: 'CIT11', top: '50%', left: '490px' },
    { spot_id: 'CIT12', top: '50%', left: '525px' },
    { spot_id: 'CIT13', top: '50%', left: '560px' },
    { spot_id: 'CIT14', top: '50%', left: '595px' },
    { spot_id: 'CIT15', top: '50%', left: '630px' },
    { spot_id: 'CIT16', top: '50%', left: '665px' }
  ],
  building5: [
    { spot_id: 'MNT1', top: '52%', left: '295px' },
    { spot_id: 'MNT2', top: '52%', left: '349px' },
    { spot_id: 'MNT3', top: '52%', left: '403px' },
    { spot_id: 'MNT4', top: '52%', left: '459px' },
    { spot_id: 'MNT5', top: '52%', left: '513px' },
    { spot_id: 'MNT6', top: '75.9%', left: '295px' },
    { spot_id: 'MNT7', top: '75.9%', left: '349px' },
    { spot_id: 'MNT8', top: '75.9%', left: '404px' },
    { spot_id: 'MNT9', top: '75.9%', left: '460px' },
    { spot_id: 'MNT10', top: '75.9%', left: '514px' }
  ],
  building6: [
    { spot_id: 'IRTC1', top: '49.8%', left: '213px' },
    { spot_id: 'IRTC2', top: '49.8%', left: '266px' },
    { spot_id: 'IRTC3', top: '49.8%', left: '319px' },
    { spot_id: 'IRTC4', top: '49.8%', left: '374px' },
    { spot_id: 'IRTC5', top: '49.8%', left: '427px' }
  ],
  building7: [
    { spot_id: 'ADM1', top: '49%', left: '50px' },
    { spot_id: 'ADM2', top: '49%', left: '101px' },
    { spot_id: 'ADM3', top: '49%', left: '151px' },
    { spot_id: 'ADM4', top: '49%', left: '201px' },
    { spot_id: 'ADM5', top: '49%', left: '251px' },
    { spot_id: 'ADM6', top: '49%', left: '301px' },
  ]
};

// ==========================================
// 3. CORE LOGIC
// ==========================================
// ... (Logic remains the same up to handleSpotClick) ...

function updateDashboardCounts(dbSpots, selectedType) {
Â  const buildingMap = {
Â  Â  building1: 'count-building1', building2: 'count-building2',
Â  Â  building3: 'count-building3', building4: 'count-building4',
Â  Â  building5: 'count-building5', building6: 'count-building6',
Â  Â  building7: 'count-building7'
Â  };

Â  for (const [key, elementId] of Object.entries(buildingMap)) {
Â  Â  const spotsInBuilding = parkingSpots[key];
Â  Â  if (!spotsInBuilding) continue;
Â  Â  const total = spotsInBuilding.length;
Â  Â  let occupiedCount = 0;

Â  Â  spotsInBuilding.forEach(spot => {
Â  Â  Â  const dbRecord = dbSpots.find(d => d.slot_number === spot.spot_id);
Â  Â  Â  if (dbRecord && (dbRecord.status === 'occupied' || dbRecord.status === 'unavailable')) {
Â  Â  Â  Â  // Count specific vehicle type if filtered, or all if 'all'
Â  Â  Â  Â  const vType = dbRecord.vehicle_type || '';
Â  Â  Â  Â  if (selectedType === 'all' || vType === selectedType) {
Â  Â  Â  Â  Â  Â  occupiedCount++;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  const element = document.getElementById(elementId);
Â  Â  if (element) {
Â  Â  Â  Â  element.innerText = `${occupiedCount}/${total}`;
Â  Â  Â  Â  element.className = occupiedCount > 0 ? 'value-red' : 'value-green';
Â  Â  }
Â  }
}

async function fetchAndRenderSpots(location) {
Â  try {
Â  Â  const response = await fetch('/api/spots'); 
Â  Â  const dbSpots = await response.json(); 

Â  Â  const selectedType = vehicleTypeSelect.value;
Â  Â  const showAvailable = availableCheckbox.checked;
Â  Â  const showUnavailable = unavailableCheckbox.checked;

Â  Â  // Update numbers based on the filter
Â  Â  updateDashboardCounts(dbSpots, selectedType);

Â  Â  const currentBuildingSpots = parkingSpots[location]; 
Â  Â  if (!currentBuildingSpots) return;

Â  Â  spotsContainer.innerHTML = '';

Â  Â  currentBuildingSpots.forEach(coordSpot => {
Â  Â  Â  Â  const dbData = dbSpots.find(db => db.slot_number === coordSpot.spot_id);
Â  Â  Â  Â  
Â  Â  Â  Â  const status = dbData ? dbData.status : 'available';
Â  Â  Â  Â  const vehicle = dbData ? dbData.plate_number : '';
Â  Â  Â  Â  const time = dbData ? dbData.start_time : ''; 
Â  Â  Â  Â  const vType = dbData ? dbData.vehicle_type : ''; 

Â  Â  Â  Â  // --- FILTER LOGIC (THE REQUESTED BEHAVIOR) ---
Â  Â  Â  Â  let shouldShow = false;

Â  Â  Â  Â  if (selectedType === 'all') {
Â  Â  Â  Â  Â  Â  // Case 1: "All" is selected -> DEPENDENT on checkboxes
Â  Â  Â  Â  Â  Â  if (status === 'available' && showAvailable) shouldShow = true;
Â  Â  Â  Â  Â  Â  if (status === 'occupied' && showUnavailable) shouldShow = true;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Case 2: Specific Type (Car/Motorcycle) -> INDEPENDENT
Â  Â  Â  Â  Â  Â  // Show ONLY occupied spots of this type. Ignore empty spots.
Â  Â  Â  Â  Â  Â  if (status === 'occupied' && vType === selectedType) {
Â  Â  Â  Â  Â  Â  Â  Â  shouldShow = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (!shouldShow) return; // Skip rendering this spot
Â  Â  Â  Â  // ----------------------------------------------------

Â  Â  Â  Â  // Create Box
Â  Â  Â  Â  const box = document.createElement('div');
Â  Â  Â  Â  box.classList.add('spot', status === 'occupied' ? 'unavailable' : 'available');
Â  Â  Â  Â  box.style.top = coordSpot.top;
Â  Â  Â  Â  box.style.left = coordSpot.left;
Â  Â  Â  Â  
Â  Â  Â  Â  const size = buildingSpotSizes[location];
Â  Â  Â  Â  if (size) {
Â  Â  Â  Â  Â  box.style.width = `${size.width}px`;
Â  Â  Â  Â  Â  box.style.height = `${size.height}px`;
Â  Â  Â  Â  }

Â  Â  Â  Â  box.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â handleSpotClick({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â spot_id: coordSpot.spot_id, 
Â  Â  Â  Â  Â  Â  Â  Â  Â status: status, 
Â  Â  Â  Â  Â  Â  Â  Â  Â vehicle_no: vehicle, 
Â  Â  Â  Â  Â  Â  Â  Â  Â park_time: time,
Â  Â  Â  Â  Â  Â  Â  Â  Â vehicle_type: vType 
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  });

Â  Â  Â  Â  spotsContainer.appendChild(box);
Â  Â  });
Â  Â  
Â  Â  setTimeout(() => document.querySelectorAll('.spot').forEach(s => s.classList.add('show')), 50);

Â  } catch (err) {
Â  Â  console.error("Error loading spots:", err);
Â  }
}

// ==========================================
// 4. MODAL LOGIC (Includes Vehicle Type)
// ==========================================

function closeModal() {
Â  modal.classList.remove('show-modal');
}

function handleSpotClick(spotData) {
Â  modalTitle.textContent = `Spot ID: ${spotData.spot_id}`;

Â  if (spotData.status === 'occupied' || spotData.status === 'unavailable') {
Â  Â  
Â  Â  // --- START FINAL TIME DISPLAY FIX (Manual Calculation) ---
Â  Â  let displayTime = 'N/A';
Â  Â  if (spotData.park_time) {
Â  Â  Â  Â  // The time string from the server is 'YYYY-MM-DD HH:MI:SS' (Manila Time)
Â  Â  Â  Â  const timeString = spotData.park_time;
Â  Â  Â  Â  
Â  Â  Â  Â  // Use a simple Date constructor, but we must manually extract and format.
Â  Â  Â  Â  // NOTE: The 'replace' is a trick to make the string more compliant with ISO format,
Â  Â  Â  Â  // reducing unpredictable browser behavior.
Â  Â  Â  Â  const date = new Date(timeString.replace(/-/g, "/")); 
Â  Â  Â  Â  
Â  Â  Â  Â  // Since the server sends the time already set to 'Asia/Manila' via TO_CHAR(),
Â  Â  Â  Â  // we use getHours() to get the 24h hours directly and then manually convert to 12h AM/PM.

Â  Â  Â  Â  const hours = date.getHours();
Â  Â  Â  Â  const minutes = date.getMinutes().toString().padStart(2, '0');
Â  Â  Â  Â  const seconds = date.getSeconds().toString().padStart(2, '0');
Â  Â  Â  Â  const ampm = hours >= 12 ? 'PM' : 'AM';
Â  Â  Â  Â  
Â  Â  Â  Â  // Convert 24h time to 12h time (13 -> 1, 0 -> 12)
Â  Â  Â  Â  const displayHours = hours % 12 || 12; 
Â  Â  Â  Â  
Â  Â  Â  Â  displayTime = `${displayHours.toString().padStart(2, '0')}:${minutes}:${seconds} ${ampm}`;
Â  Â  }
Â  Â  // --- END FINAL TIME DISPLAY FIX ---

Â  Â  modalBody.innerHTML = `
Â  Â  Â  <p>THIS SPOT IS OCCUPIED.</p>
Â  Â  Â  <p>Vehicle: <strong>${spotData.vehicle_no}</strong></p>
Â  Â  Â  <p>Type: <strong>${spotData.vehicle_type || 'N/A'}</strong></p>
Â  Â  Â  <p>Time: <strong>${displayTime}</strong></p>
Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  <button class="action-btn-release" onclick="releaseSpot('${spotData.spot_id}')">Release Spot</button>
Â  Â  Â  </div>
Â  Â  `;
Â  } else {
Â  Â  modalBody.innerHTML = `
Â  Â  Â  <p>THIS SPOT IS AVAILABLE.</p>
Â  Â  Â  
Â  Â  Â  <div class="form-group-modal">
Â  Â  Â  Â  <label>Vehicle Number:</label>
Â  Â  Â  Â  <input type="text" id="vehicle-input-${spotData.spot_id}" placeholder="Enter plate number" required>
Â  Â  Â  </div>

Â  Â  Â  <div class="form-group-modal">
Â  Â  Â  Â  <label>Vehicle Type:</label>
Â  Â  Â  Â  <select id="vehicle-type-input-${spotData.spot_id}" style="width: 100%; padding: 10px; border-radius: 5px; color: black;">
Â  Â  Â  Â  Â  Â  <option value="Car">Car</option>
Â  Â  Â  Â  Â  Â  <option value="Motorcycle">Motorcycle</option>
Â  Â  Â  Â  Â  Â  <option value="Van">Van</option>
Â  Â  Â  Â  Â  Â  <option value="Others">Others</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  <button class="action-btn-occupy" onclick="occupySpot('${spotData.spot_id}')">Occupy Spot</button>
Â  Â  Â  </div>
Â  Â  `;
Â  }
Â  modal.classList.add('show-modal');
}

function getManilaTimeString() {
Â  const now = new Date();

Â  // Convert to Asia/Manila timezone using Intl API
Â  const options = {
Â  Â  timeZone: 'Asia/Manila',
Â  Â  year: 'numeric',
Â  Â  month: '2-digit',
Â  Â  day: '2-digit',
Â  Â  hour: '2-digit',
Â  Â  minute: '2-digit',
Â  Â  second: '2-digit',
Â  Â  hour12: false
Â  };

Â  const formatter = new Intl.DateTimeFormat('en-CA', options);
Â  const parts = formatter.formatToParts(now);

Â  const dateParts = {};
Â  parts.forEach(({ type, value }) => {
Â  Â  dateParts[type] = value;
Â  });

Â  // Reconstruct the date/time string in a format PostgreSQL accepts (YYYY-MM-DD HH:MI:SS)
Â  return `${dateParts.year}-${dateParts.month}-${dateParts.day} ${dateParts.hour}:${dateParts.minute}:${dateParts.second}`;
}

function occupySpot(spotId) {
Â  const vehicleInput = document.getElementById(`vehicle-input-${spotId}`);
Â  const typeInput = document.getElementById(`vehicle-type-input-${spotId}`); 

Â  const vehicleNo = vehicleInput.value;
Â  const vehicleType = typeInput.value;

Â  // Get Local Time in MANILA TIMEZONE (The fix is here)
Â  const time = getManilaTimeString();

Â  fetch('/api/update-spot', {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  slot_id: spotId, 
Â  Â  Â  Â  Â  status: 'occupied', 
Â  Â  Â  Â  Â  plate_number: vehicleNo, 
Â  Â  Â  Â  Â  park_time: time,
Â  Â  Â  Â  Â  vehicle_type: vehicleType 
Â  Â  Â  })
Â  })
Â  .then(response => response.json()) 
Â  .then(data => {
Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  fetchAndRenderSpots(locationSelect.value); 
Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert(data.message); 
Â  Â  Â  }
Â  })
Â  .catch(err => {
Â  Â  Â  console.error(err);
Â  Â  Â  alert("System Error. Please try again.");
Â  });
}

function releaseSpot(spotId) {
Â  if (!confirm(`Release spot ${spotId}?`)) return;

Â  fetch('/api/update-spot', {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  slot_id: spotId, 
Â  Â  Â  Â  Â  status: 'available', 
Â  Â  Â  Â  Â  plate_number: null, 
Â  Â  Â  Â  Â  park_time: null,
Â  Â  Â  Â  Â  vehicle_type: null
Â  Â  Â  })
Â  }).then(() => {
Â  Â  Â  closeModal();
Â  Â  Â  fetchAndRenderSpots(locationSelect.value);
Â  });
}

window.onclick = (e) => { 
Â  Â  if (e.target === modal) closeModal(); 
Â  Â  if (e.target === logsModal) closeLogsModal();
Â  Â  if (e.target === chartsModal) closeChartsModal();
}

// ==========================================
// 5. EVENT LISTENERS
// ==========================================

locationSelect.addEventListener('change', (e) => {
Â  const newImage = mapImages[e.target.value] || mapImages.none;
Â  mapImage.src = newImage;
Â  fetchAndRenderSpots(e.target.value);
});

// --- UPDATED: Handle Vehicle Type Change (Locks the Checkbox) ---
vehicleTypeSelect.addEventListener('change', () => {
Â  Â  const type = vehicleTypeSelect.value;

Â  Â  if (type !== 'all') {
Â  Â  Â  Â  // LOCK LOGIC: If specific type selected (Car, Van, etc.)
Â  Â  Â  Â  availableCheckbox.checked = false; 
Â  Â  Â  Â  availableCheckbox.disabled = true; 
Â  Â  Â  Â  
Â  Â  Â  Â  unavailableCheckbox.checked = true; 
Â  Â  } else {
Â  Â  Â  Â  // UNLOCK LOGIC: If 'All' is selected
Â  Â  Â  Â  availableCheckbox.disabled = false; 
Â  Â  }

Â  Â  fetchAndRenderSpots(locationSelect.value);
});

availableCheckbox.addEventListener('change', () => fetchAndRenderSpots(locationSelect.value));
unavailableCheckbox.addEventListener('change', () => fetchAndRenderSpots(locationSelect.value));

// --- UPDATED: Reset Button (Unlocks everything) ---
resetButton.addEventListener('click', () => {
Â  locationSelect.value = 'none';
Â  vehicleTypeSelect.value = 'all'; 
Â  
Â  // Reset Checkboxes
Â  availableCheckbox.disabled = false; 
Â  availableCheckbox.checked = false;
Â  unavailableCheckbox.checked = false;
Â  
Â  fetchAndRenderSpots('none');
});

// Initial Load
fetchAndRenderSpots('none');
window.addEventListener("load", () => document.body.classList.add("fade-in"));

// --- LOGS MODAL LOGIC ---
const logsModal = document.getElementById('logs-modal');
const logsList = document.getElementById('logs-list');

function openLogsModal() {
Â  Â  logsModal.classList.add('show-modal');
Â  Â  fetchLogs();
}

function closeLogsModal() {
Â  Â  logsModal.classList.remove('show-modal');
}

async function fetchLogs() {
Â  Â  try {
Â  Â  Â  Â  const response = await fetch('/api/logs');
Â  Â  Â  Â  const logs = await response.json();
Â  Â  Â  Â  logsList.innerHTML = '';
Â  Â  Â  Â  logs.forEach(log => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.style.padding = '10px';
Â  Â  Â  Â  Â  Â  item.style.borderBottom = '1px solid #444';
Â  Â  Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong style="color: #22c55e">${log.action}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #888; font-size: 0.8em;">${new Date(log.timestamp).toLocaleString()}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="color: #fff;">${log.username}: ${log.details}</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  logsList.appendChild(item);
Â  Â  Â  Â  });
Â  Â  } catch (err) { console.error(err); }
}

// --- NEW CHARTS MODAL LOGIC ---
const chartsModal = document.getElementById('charts-modal');

function openChartsModal() {
Â  Â  chartsModal.classList.add('show-modal');
Â  Â  initializeCharts();
}

function closeChartsModal() {
Â  Â  chartsModal.classList.remove('show-modal');
}

// ==========================================
// 6. AUTO SESSION TIMEOUT (Idle Detection)
// ... (Section 6 remains the same) ...
// ==========================================
let idleTime = 0;

const TIMEOUT_LIMIT = 15 * 60 * 1000; 

function resetTimer() {
Â  Â  idleTime = 0;
}

document.onmousemove = resetTimer;
document.onkeypress = resetTimer;
document.onclick = resetTimer;
document.onscroll = resetTimer;

setInterval(() => {
Â  Â  if (idleTime >= TIMEOUT_LIMIT) {
Â  Â  Â  Â  fetch('/api/session-timeout', { method: 'POST' })
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  alert("Session Expired due to inactivity. You have been logged out.");
Â  Â  Â  Â  Â  Â  window.location.href = '/login-page';
Â  Â  Â  Â  });
Â  Â  }
Â  Â  idleTime += 1000; 
}, 1000);


// ==========================================
// 7. CHART.JS IMPLEMENTATION LOGIC ðŸ“Š
// ... (Section 7 remains the same) ...
// ==========================================

let dailyChart, weeklyChart, monthlyChart;
const TOTAL_SPOTS = 85; 

async function fetchChartData(endpoint) {
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(endpoint);
Â  Â  Â  Â  if (!response.ok) throw new Error('Network response was not ok');
Â  Â  Â  Â  return await response.json();
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(`Error fetching data from ${endpoint}:`, error);
Â  Â  Â  Â  return [];
Â  Â  }
}

async function initializeCharts() {
Â  Â  const dailyDataRaw = await fetchChartData('/api/charts/daily');
Â  Â  const weeklyDataRaw = await fetchChartData('/api/charts/weekly');
Â  Â  const monthlyDataRaw = await fetchChartData('/api/charts/monthly');

Â  Â  if (dailyChart) dailyChart.destroy();
Â  Â  if (weeklyChart) weeklyChart.destroy();
Â  Â  if (monthlyChart) monthlyChart.destroy();

Â  Â  const dailyLabels = dailyDataRaw.map(d => d.hour_label + ':00');
Â  Â  const dailyOccupied = dailyDataRaw.map(d => parseInt(d.occupied_count, 10));

Â  Â  const weeklyLabels = weeklyDataRaw.map(d => d.day_label);
Â  Â  const weeklyOccupied = weeklyDataRaw.map(d => parseInt(d.occupied_slots_count, 10));

Â  Â  const monthlyLabels = monthlyDataRaw.map(d => d.month_label);
Â  Â  const monthlyAvgOccupied = monthlyDataRaw.map(d => parseInt(d.average_occupied_slots, 10));

Â  Â  // --- Daily Chart (Line) ---
Â  Â  const dailyCtx = document.getElementById('dailyOccupancyChart').getContext('2d');
Â  Â  dailyChart = new Chart(dailyCtx, {
Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: dailyLabels,
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  label: 'Occupied Spots',
Â  Â  Â  Â  Â  Â  Â  Â  data: dailyOccupied,
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(0, 123, 255, 0.2)',
Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#007bff',
Â  Â  Â  Â  Â  Â  Â  Â  pointBackgroundColor: '#007bff',
Â  Â  Â  Â  Â  Â  Â  Â  pointBorderColor: '#fff',
Â  Â  Â  Â  Â  Â  Â  Â  pointHoverBackgroundColor: '#fff',
Â  Â  Â  Â  Â  Â  Â  Â  pointHoverBorderColor: '#007bff',
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  fill: true,
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  maintainAspectRatio: true,
Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: { display: true, text: 'Number of Spots' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max: TOTAL_SPOTS + 5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(255, 255, 255, 0.1)' }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  x: { grid: { display: false } }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false },
Â  Â  Â  Â  Â  Â  Â  Â  title: { display: false }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- Weekly Chart (Bar) ---
Â  Â  const weeklyCtx = document.getElementById('weeklyOccupancyChart').getContext('2d');
Â  Â  weeklyChart = new Chart(weeklyCtx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: weeklyLabels,
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  label: 'Occupied Slots',
Â  Â  Â  Â  Â  Â  Â  Â  data: weeklyOccupied,
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(34, 197, 94, 0.7)',
Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#22c55e',
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: { display: true, text: 'Number of Spots' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max: TOTAL_SPOTS + 5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(255, 255, 255, 0.1)' }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  x: { grid: { display: false } }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false },
Â  Â  Â  Â  Â  Â  Â  Â  title: { display: false }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- Monthly Chart (LINE CHART for trend) ---
Â  Â  const monthlyCtx = document.getElementById('monthlyOccupancyChart').getContext('2d');
Â  Â  monthlyChart = new Chart(monthlyCtx, {
Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: monthlyLabels,
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  label: 'Avg. Occupied Slots',
Â  Â  Â  Â  Â  Â  Â  Â  data: monthlyAvgOccupied,
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(255, 159, 64, 0.2)', 
Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#ff9f40',
Â  Â  Â  Â  Â  Â  Â  Â  pointBackgroundColor: '#ff9f40',
Â  Â  Â  Â  Â  Â  Â  Â  pointBorderColor: '#fff',
Â  Â  Â  Â  Â  Â  Â  Â  pointHoverBackgroundColor: '#fff',
Â  Â  Â  Â  Â  Â  Â  Â  pointHoverBorderColor: '#ff9f40',
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  fill: true,
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  maintainAspectRatio: true,
Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: { display: true, text: 'Avg. Occupied Slots' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max: TOTAL_SPOTS + 5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(255, 255, 255, 0.1)' }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  x: { grid: { display: false } }
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false },
Â  Â  Â  Â  Â  Â  Â  Â  title: { display: false }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
}
</script>
</body>
</html>